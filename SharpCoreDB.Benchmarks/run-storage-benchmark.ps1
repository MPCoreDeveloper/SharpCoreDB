#!/usr/bin/env pwsh
# SharpCoreDB Storage Engine Benchmark Runner
# Usage: .\run-storage-benchmark.ps1

Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?     SharpCoreDB Storage Engine Benchmark                       ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# Navigate to benchmark directory
$scriptPath = Split-Path -Parent $MyInvocation.MyCommand.Path
Set-Location $scriptPath

Write-Host "?? Working directory: $scriptPath" -ForegroundColor Gray
Write-Host ""

# Option 1: Run as XUnit test (RECOMMENDED - Fast & Simple)
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Yellow
Write-Host " Option 1: XUnit Test (Recommended - Fast)" -ForegroundColor Yellow
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Yellow
Write-Host ""

$response = Read-Host "Run XUnit comparison test? (Y/n)"
if ($response -eq "" -or $response -eq "Y" -or $response -eq "y") {
    Write-Host ""
    Write-Host "?? Running Storage Engine Comparison Test..." -ForegroundColor Green
    Write-Host ""
    
    Set-Location "..\SharpCoreDB.Tests"
    dotnet test --filter "FullyQualifiedName~StorageEngineComparisonTest" --logger "console;verbosity=normal"
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host ""
        Write-Host "? Test completed successfully!" -ForegroundColor Green
        Write-Host ""
        
        # Check if report was generated
        $reportPath = Join-Path (Get-Location) "STORAGE_ENGINE_COMPARISON.md"
        if (Test-Path $reportPath) {
            Write-Host "?? Report generated: $reportPath" -ForegroundColor Cyan
            Write-Host ""
            
            $viewReport = Read-Host "View report? (Y/n)"
            if ($viewReport -eq "" -or $viewReport -eq "Y" -or $viewReport -eq "y") {
                Get-Content $reportPath | Write-Host
            }
        }
    } else {
        Write-Host ""
        Write-Host "? Test failed with exit code: $LASTEXITCODE" -ForegroundColor Red
        Write-Host ""
    }
    
    Set-Location $scriptPath
    Write-Host ""
    Write-Host "Press any key to continue..." -ForegroundColor Gray
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
}

Write-Host ""
Write-Host ""

# Option 2: Run as BenchmarkDotNet (Detailed but slower)
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Yellow
Write-Host " Option 2: BenchmarkDotNet (Detailed - Slower)" -ForegroundColor Yellow
Write-Host "???????????????????????????????????????????????????????????????" -ForegroundColor Yellow
Write-Host ""
Write-Host "Note: This runs comprehensive benchmarks with statistical analysis" -ForegroundColor Gray
Write-Host "      Estimated time: 10-20 minutes" -ForegroundColor Gray
Write-Host ""

$response = Read-Host "Run BenchmarkDotNet benchmarks? (y/N)"
if ($response -eq "Y" -or $response -eq "y") {
    Write-Host ""
    Write-Host "?? Running BenchmarkDotNet Storage Engine Benchmarks..." -ForegroundColor Green
    Write-Host ""
    
    # Build in Release mode first
    Write-Host "?? Building in Release mode..." -ForegroundColor Yellow
    dotnet build -c Release --nologo
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "? Build successful" -ForegroundColor Green
        Write-Host ""
        
        # Run the benchmark directly targeting the StorageEngineBenchmark class
        Write-Host "?? Running benchmarks..." -ForegroundColor Yellow
        Write-Host ""
        
        dotnet run -c Release --no-build --project SharpCoreDB.Benchmarks.csproj
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host ""
            Write-Host "? Benchmarks completed!" -ForegroundColor Green
            Write-Host ""
            Write-Host "?? Results location:" -ForegroundColor Cyan
            Write-Host "   BenchmarkDotNet.Artifacts/results/" -ForegroundColor White
            Write-Host ""
            
            $viewResults = Read-Host "Open results directory? (Y/n)"
            if ($viewResults -eq "" -or $viewResults -eq "Y" -or $viewResults -eq "y") {
                $resultsPath = Join-Path $scriptPath "BenchmarkDotNet.Artifacts\results"
                if (Test-Path $resultsPath) {
                    Start-Process explorer.exe $resultsPath
                }
            }
        } else {
            Write-Host ""
            Write-Host "? Benchmarks failed with exit code: $LASTEXITCODE" -ForegroundColor Red
        }
    } else {
        Write-Host "? Build failed" -ForegroundColor Red
    }
}

Write-Host ""
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host " Quick Reference" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""
Write-Host "Manual commands:" -ForegroundColor Yellow
Write-Host ""
Write-Host "  # XUnit Test (Fast)" -ForegroundColor White
Write-Host "  cd ..\SharpCoreDB.Tests" -ForegroundColor Gray
Write-Host "  dotnet test --filter StorageEngineComparisonTest" -ForegroundColor Gray
Write-Host ""
Write-Host "  # BenchmarkDotNet (Detailed)" -ForegroundColor White
Write-Host "  cd SharpCoreDB.Benchmarks" -ForegroundColor Gray
Write-Host "  dotnet run -c Release" -ForegroundColor Gray
Write-Host ""
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""
