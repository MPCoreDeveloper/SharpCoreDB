# SharpCoreDB Binary Format - Visual Reference Guide

## 1. Overall .scdb File Structure

```
SCDB File (Single file for entire database)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Byte 0 - 511: SCDB File Header (512 bytes, fixed)          â”‚
â”‚ â”œâ”€ Magic: 0x4243445310000000 ("SCDB\x10")                 â”‚
â”‚ â”œâ”€ Version, PageSize, Offsets to all regions             â”‚
â”‚ â”œâ”€ Encryption/Compression info                           â”‚
â”‚ â”œâ”€ Transaction state, checksums                          â”‚
â”‚ â””â”€ Statistics (record count, fragmentation %)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Byte 512 - N: Block Registry                               â”‚
â”‚ â”œâ”€ Maps logical block names â†’ physical offsets            â”‚
â”‚ â””â”€ Enables O(1) record lookups                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Free Space Map (FSM)                                        â”‚
â”‚ â”œâ”€ 2-level bitmap for page allocation                     â”‚
â”‚ â”œâ”€ L1: 1 bit per page (allocated=1, free=0)             â”‚
â”‚ â””â”€ L2: Extent map for large allocations                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Write-Ahead Log (WAL)                                       â”‚
â”‚ â”œâ”€ Transaction log entries                                â”‚
â”‚ â”œâ”€ Enables crash recovery & ACID guarantees              â”‚
â”‚ â””â”€ Appended to, never random-access                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Table Directory                                             â”‚
â”‚ â”œâ”€ Table schemas                                          â”‚
â”‚ â”œâ”€ Column definitions                                     â”‚
â”‚ â””â”€ Table metadata                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Data Pages (Allocated from FSM)                            â”‚
â”‚ â”œâ”€ Record blocks scattered throughout file                â”‚
â”‚ â”œâ”€ Can be fragmented (normal, FSM handles it)            â”‚
â”‚ â””â”€ No fixed positions                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

All region offsets defined in Header (bytes 0x20-0x5F)
```

---

## 2. File Header Structure (512 bytes)

```
SCDB File Header Layout:

Offset   Size   Field Name                Value
â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0x0000   8      Magic                     0x4243445310000000
0x0008   2      FormatVersion             1
0x000A   2      PageSize                  4096 (default)
0x000C   4      HeaderSize                512 (always)

0x0010   1      EncryptionMode            0=None, 1=AES-256-GCM
0x0011   1      CompressionMode           0=None (reserved)
0x0012   2      EncryptionKeyId           Key derivation ID
0x0014   12     Nonce                     AES-GCM nonce

0x0020   8      BlockRegistryOffset       Start of registry
0x0028   8      BlockRegistryLength       Registry size
0x0030   8      FsmOffset                 Start of FSM
0x0038   8      FsmLength                 FSM size
0x0040   8      WalOffset                 Start of WAL
0x0048   8      WalLength                 WAL size
0x0050   8      TableDirOffset            Start of table dir
0x0058   8      TableDirLength            Table dir size

0x0060   8      LastTransactionId         Last committed txn
0x0068   8      LastCheckpointLsn         LSN at checkpoint
0x0070   8      FileSize                  Total file size
0x0078   8      AllocatedPages            Number of pages

0x0080   32     FileChecksum              SHA-256 of entire file

0x00A0   8      TotalRecords              Total record count
0x00A8   8      TotalDeletes              Deleted record count
0x00B0   8      LastVacuumTime            Unix timestamp
0x00B8   8      FragmentationPercent      0-10000 (0.00%-100.00%)

0x00C0   240    Reserved                  For future extensions

Total: 512 bytes (0x200)
```

---

## 3. Binary Record Format

### Simple Record Example

Input:
```csharp
var row = new Dictionary<string, object>
{
    ["UserId"] = 42,
    ["Name"] = "John Doe",
    ["Active"] = true,
};
```

Binary Output:
```
Offset  Bytes   Meaning
â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0-3     04 00 00 00     ColumnCount = 4 (little-endian int32)

4-7     06 00 00 00     NameLength("UserId") = 6
8-13    55 73 65 72 49 64  "UserId" (UTF-8)
14      01              TypeMarker = 1 (Int32)
15-18   2A 00 00 00     Value = 42 (little-endian int32)

19-22   04 00 00 00     NameLength("Name") = 4
23-26   4E 61 6D 65     "Name" (UTF-8)
27      06              TypeMarker = 6 (String)
28-31   09 00 00 00     StringLength = 9 (length of "John Doe")
32-40   4A 6F 68 6E 20 44 6F 65  "John Doe" (UTF-8)

41-44   06 00 00 00     NameLength("Active") = 6
45-50   41 63 74 69 76 65  "Active" (UTF-8)
51      04              TypeMarker = 4 (Boolean)
52      01              Value = 1 (true)

Total: 83 bytes
```

### Detailed Byte Layout

```
Record with Mixed Types:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ColumnCount (4 bytes)                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 04 00 00 00                                   â”‚   â”‚ Little-endian
â”‚ â”‚ = 4 columns                                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Column 1: Integer Field                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ NameLen: 02 00 00 00 â†’ 2 bytes                â”‚   â”‚
â”‚ â”‚ Name: 49 64 â†’ "Id"                            â”‚   â”‚ UTF-8
â”‚ â”‚ Type: 01 â†’ Int32                              â”‚   â”‚
â”‚ â”‚ Value: 2A 00 00 00 â†’ 42                       â”‚   â”‚ Little-endian
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Column 2: String Field                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ NameLen: 04 00 00 00 â†’ 4 bytes                â”‚   â”‚
â”‚ â”‚ Name: 4E 61 6D 65 â†’ "Name"                    â”‚   â”‚ UTF-8
â”‚ â”‚ Type: 06 â†’ String                             â”‚   â”‚
â”‚ â”‚ StrLen: 04 00 00 00 â†’ 4 bytes                 â”‚   â”‚ Little-endian
â”‚ â”‚ Value: 4A 6F 68 6E â†’ "John"                   â”‚   â”‚ UTF-8
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Column 3: Float Field                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ NameLen: 05 00 00 00 â†’ 5 bytes                â”‚   â”‚
â”‚ â”‚ Name: 50 72 69 63 65 â†’ "Price"                â”‚   â”‚ UTF-8
â”‚ â”‚ Type: 03 â†’ Double                             â”‚   â”‚
â”‚ â”‚ Value: 9A 99 99 99 99 99 24 40 â†’ 10.5        â”‚   â”‚ IEEE 754 LE
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Column 4: NULL Field                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ NameLen: 07 00 00 00 â†’ 7 bytes                â”‚   â”‚
â”‚ â”‚ Name: 4F 70 74 69 6F 6E 61 6C â†’ "Optional"   â”‚   â”‚ UTF-8
â”‚ â”‚ Type: 00 â†’ Null                               â”‚   â”‚
â”‚ â”‚ Value: (none - 0 bytes)                       â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Type Markers Reference

```
Type Marker (1 byte per field)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Marker   â”‚ Type     â”‚ Value Format            â”‚ Total Bytes* â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x00     â”‚ Null     â”‚ (no value)              â”‚ 1            â”‚
â”‚ 0x01     â”‚ Int32    â”‚ Little-endian int       â”‚ 1 + 4 = 5    â”‚
â”‚ 0x02     â”‚ Int64    â”‚ Little-endian long      â”‚ 1 + 8 = 9    â”‚
â”‚ 0x03     â”‚ Double   â”‚ IEEE 754 double         â”‚ 1 + 8 = 9    â”‚
â”‚ 0x04     â”‚ Boolean  â”‚ 0x00 (false) or 0x01   â”‚ 1 + 1 = 2    â”‚
â”‚ 0x05     â”‚ DateTime â”‚ Ticks (int64)           â”‚ 1 + 8 = 9    â”‚
â”‚ 0x06     â”‚ String   â”‚ [Len:4][UTF-8:N]       â”‚ 1 + 4 + N    â”‚
â”‚ 0x07     â”‚ Bytes    â”‚ [Len:4][Raw:N]         â”‚ 1 + 4 + N    â”‚
â”‚ 0x08     â”‚ Decimal  â”‚ 16-byte decimal128     â”‚ 1 + 16 = 17  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

* Total includes type marker byte
```

---

## 5. String Encoding Example

### Variable-Length String Storage

```
String: "CafÃ©" (4 visible characters, 5 UTF-8 bytes)

Breakdown:
  C    â†’ 0x43 (1 byte)
  a    â†’ 0x61 (1 byte)
  f    â†’ 0x66 (1 byte)
  Ã©    â†’ 0xC3 0xA9 (2 bytes in UTF-8)
  Total: 5 bytes

Serialized (with type marker):
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 06   â”‚ 05 00 00 00  â”‚ 43 61 66 C3 A9            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Type â”‚ Length = 5   â”‚ "CafÃ©" (UTF-8 encoded)    â”‚
â”‚Stringâ”‚ (int32 LE)   â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Note: NO PADDING. Exactly 5 bytes for the string data.
If string was "Cat" (3 chars = 3 bytes), output would be 3 bytes, not 5.
```

### Unicode Handling Examples

```
ASCII String "Hello" (5 chars = 5 bytes):
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 06   â”‚ 05 00 00 00  â”‚ 48 65 6C 6C 6F          â”‚
â”‚ Type â”‚ Length = 5   â”‚ "Hello"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Japanese String "æ—¥æœ¬" (2 chars = 6 bytes in UTF-8):
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 06   â”‚ 06 00 00 00  â”‚ E6 97 A5 E6 9C AC        â”‚
â”‚ Type â”‚ Length = 6   â”‚ "æ—¥æœ¬"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Emoji "ğŸš€" (1 char = 4 bytes in UTF-8):
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 06   â”‚ 04 00 00 00  â”‚ F0 9F 9A 80             â”‚
â”‚ Type â”‚ Length = 4   â”‚ "ğŸš€"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Block Registry Layout

```
Block Registry Format (in-file):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Registry Header (64 bytes)                          â”‚
â”‚ â”œâ”€ EntryCount: 8 bytes (int64 LE) = N entries     â”‚
â”‚ â”œâ”€ IndexVersion: 8 bytes (version)                â”‚
â”‚ â””â”€ Metadata... (48 bytes reserved)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Entry 1 (Variable size)                            â”‚
â”‚ â”œâ”€ [NameLength: 4]  â†’ 10                          â”‚
â”‚ â”œâ”€ [Name: 10]       â†’ "Users_001"                â”‚
â”‚ â”œâ”€ [Offset: 8]      â†’ 1,048,576 (byte position)  â”‚
â”‚ â”œâ”€ [Length: 8]      â†’ 50 (block size)            â”‚
â”‚ â”œâ”€ [Checksum: 32]   â†’ SHA-256 hash               â”‚
â”‚ â”œâ”€ [CreatedAt: 8]   â†’ Unix timestamp             â”‚
â”‚ â””â”€ [LastModified:8] â†’ Unix timestamp             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Entry 2, Entry 3, ... Entry N                      â”‚
â”‚ (Same format as Entry 1)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

In-Memory Hash Table (loaded from disk):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Users_001" â†’ BlockEntry {...}           â”‚ O(1) lookup
â”‚ "Users_002" â†’ BlockEntry {...}           â”‚
â”‚ "Orders_001" â†’ BlockEntry {...}          â”‚
â”‚ ...                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Free Space Map (FSM) Structure

```
FSM Layout:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FSM Header (64 bytes)                               â”‚
â”‚ â”œâ”€ TotalPages: 8 bytes â†’ 1,000,000 pages          â”‚
â”‚ â”œâ”€ FreePages: 8 bytes â†’ 500,000 pages             â”‚
â”‚ â”œâ”€ LastAllocation: 8 bytes â†’ page 512,345         â”‚
â”‚ â””â”€ Metadata (40 bytes reserved)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ L1 Bitmap (Variable)                                â”‚
â”‚ â”œâ”€ 1 bit per page                                 â”‚
â”‚ â”œâ”€ 1 = allocated, 0 = free                        â”‚
â”‚ â”œâ”€ Example for 8 pages:                           â”‚
â”‚ â”‚  Bits: 1 1 0 1 0 1 1 1                          â”‚
â”‚ â”‚  Pages: 1 2 3 4 5 6 7 8                         â”‚
â”‚ â”‚  Status: A A F A F A A A (A=allocated, F=free)  â”‚
â”‚ â””â”€ For 1M pages: ~128 KB bitmap                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ L2 Extent Map (Variable)                            â”‚
â”‚ â”œâ”€ Each extent: [StartPage:8] [Count:8]           â”‚
â”‚ â”œâ”€ Example:                                        â”‚
â”‚ â”‚  [10, 5]       â†’ Pages 10-14 are free           â”‚
â”‚ â”‚  [100, 50]     â†’ Pages 100-149 are free         â”‚
â”‚ â”‚  [1000, 100]   â†’ Pages 1000-1099 are free       â”‚
â”‚ â””â”€ For allocation: Binary search, O(log n)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Allocation Algorithm:
1. Need N pages
2. Check L2 extents for contiguous block (O(log n))
3. If found: Mark as allocated, update bitmap
4. If not found: Extend file exponentially
5. Return allocated page number
```

---

## 8. Data Fragmentation Example

```
Real-world file layout (not contiguous):

Byte Position    Block              Size    Status
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0                 [Header]           512    Fixed
512               [Registry]         50KB   Fixed
51,712            [FSM]              10KB   Fixed
61,952            [WAL]              1MB    Fixed
1,110,016         [Table Directory]  100KB  Fixed

1,310,016         Row_001            50B    Allocated
1,310,066         Row_002            100B   Allocated
1,310,166         [Free]             4000B  Free (FSM: free=0)
1,314,166         Row_003            75B    Allocated
1,314,241         [Free]             4000B  Free (FSM: free=0)
1,318,241         Row_004            200B   Allocated
...and so on

FSM tracks free pages:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pages  â”‚ Status   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0      â”‚ Allocatedâ”‚ Header
â”‚ 1-10   â”‚ Allocatedâ”‚ Registry
â”‚ 11-14  â”‚ Allocatedâ”‚ FSM
â”‚ 15-300 â”‚ Allocatedâ”‚ WAL + Table Dir
â”‚ 301    â”‚ Allocatedâ”‚ Row_001 + Row_002
â”‚ 302    â”‚ Free     â”‚ Available for allocation
â”‚ 303    â”‚ Allocatedâ”‚ Row_003
â”‚ 304    â”‚ Free     â”‚ Available for allocation
â”‚ 305    â”‚ Allocatedâ”‚ Row_004 + more
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

When allocating 10 bytes:
1. FSM looks for free page (finds page 302 or 304)
2. Allocates there
3. Updates bitmap and L2 extent map
4. Returns page offset to caller
```

---

## 9. Write-Ahead Log (WAL) Entry Format

```
WAL Entry Structure:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TxnId (8B)  â”‚ Typ(1)â”‚ BlockLen â”‚ BlockData  â”‚ CRC32(4) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Example: INSERT transaction

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 00000000001 â”‚ I â”‚ 00000050 â”‚ [50 byte record] â”‚ ABCD1234 â”‚
â”‚ TxnId=1     â”‚ I â”‚ Length=80â”‚ Binary row data  â”‚ Checksum â”‚
â”‚             â”‚ n â”‚          â”‚                  â”‚          â”‚
â”‚             â”‚ s â”‚          â”‚                  â”‚          â”‚
â”‚             â”‚ e â”‚          â”‚                  â”‚          â”‚
â”‚             â”‚ r â”‚          â”‚                  â”‚          â”‚
â”‚             â”‚ t â”‚          â”‚                  â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Type markers:
  I = Insert
  U = Update (old block + new block)
  D = Delete
  C = Commit marker
  R = Rollback marker

On crash recovery:
1. Read WAL from last checkpoint
2. Replay all committed transactions (marked with C)
3. Ignore uncommitted (no C marker)
4. Restore database to last consistent state
```

---

## 10. Record Lookup Flow (O(1))

```
User query: SELECT * FROM Users WHERE Id = 42

Step 1: Hash lookup
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Look for block "Users_Row_42"        â”‚
â”‚ ConcurrentDictionary.TryGetValue()   â”‚
â”‚ Time: O(1) average                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
Step 2: BlockEntry retrieval
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BlockEntry entry = registry[...]     â”‚
â”‚ Offset: 1,048,576                    â”‚
â”‚ Length: 50                           â”‚
â”‚ Checksum: [SHA-256]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
Step 3: Memory-mapped read
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ byte[] data = provider.ReadBytes(    â”‚
â”‚   1,048,576,  // offset              â”‚
â”‚   50          // length              â”‚
â”‚ )                                    â”‚
â”‚ Time: O(1) + I/O                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
Step 4: Deserialize
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dictionary<string,object> row =      â”‚
â”‚   BinaryRowSerializer.Deserialize()  â”‚
â”‚ Time: O(n) where n = column count    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
Step 5: Return result
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                    â”‚
â”‚   ["Id"]: 42,                        â”‚
â”‚   ["Name"]: "John",                  â”‚
â”‚   ["Active"]: true                   â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. String Size Comparison

```
"Name" field with 1,000 records:

Fixed-length approach (255 bytes per field):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Record 1: "John" + 251 zeros    â”‚ 255 bytes
â”‚ Record 2: "Jane" + 251 zeros    â”‚ 255 bytes
â”‚ Record 3: "Bob"  + 252 zeros    â”‚ 255 bytes
â”‚ ...                             â”‚ Ã— 1,000
â”‚ Total: 255,000 bytes            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SharpCoreDB variable-length:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Record 1: [04][John]                   â”‚ 8 bytes
â”‚ Record 2: [04][Jane]                   â”‚ 8 bytes
â”‚ Record 3: [03][Bob]                    â”‚ 7 bytes
â”‚ ...                                    â”‚ Ã— 1,000
â”‚ Avg: 8 bytes per record                â”‚
â”‚ Total: ~8,000 bytes                    â”‚
â”‚                                        â”‚
â”‚ Savings: 255,000 - 8,000 = 247,000 B  â”‚
â”‚ Reduction: 96.9% âœ…                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. File Growth Pattern

```
Initial database: 100 pages (400 KB @ 4KB pages)

Insert 5,000 rows (avg 100 bytes each):

Timeline:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Initial: 100 pages                   â”‚ 400 KB
â”‚ â”œâ”€ After 1000 rows: Extend +2560 p   â”‚ 10.2 MB
â”‚ â”œâ”€ After 2000 rows: Extend +2560 p   â”‚ 20.4 MB
â”‚ â”œâ”€ After 3000 rows: Extend +5120 p   â”‚ 40.6 MB
â”‚ â”œâ”€ After 4000 rows: Extend +10240 p  â”‚ 81.0 MB
â”‚ â””â”€ After 5000 rows: (no extend)      â”‚ 81.0 MB
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Extension strategy (Phase 3):
  min_pages = 2560      // 10 MB minimum
  growth = exponential  // 2x, 4x, 8x...

Result:
  - Few allocations (4 extensions for 5000 rows)
  - Pre-allocated pages available for future writes
  - Minimal I/O overhead
  - Predictable growth
```

---

## Summary Cheat Sheet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SharpCoreDB Binary Format Cheat Sheet           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ File Header:           512 bytes (fixed)        â”‚
â”‚ Page size:             4096 bytes (default)     â”‚
â”‚ String encoding:       UTF-8                    â”‚
â”‚ Number encoding:       Little-endian            â”‚
â”‚ Record format:         Self-describing binary   â”‚
â”‚ Record lookup:         O(1) hash table          â”‚
â”‚ String overhead:       4 bytes (length prefix)  â”‚
â”‚ Type info:             1 byte per field         â”‚
â”‚ NULL handling:         Type marker 0x00         â”‚
â”‚ File growth:           Exponential (2x each)    â”‚
â”‚ Free space management: FSM (2-level bitmap)    â”‚
â”‚ Fragmentation:         Normal & handled         â”‚
â”‚ Transaction support:   WAL-based ACID           â”‚
â”‚ Max string size:       2 GB (int32 limit)       â”‚
â”‚ Max file size:         Limited by filesystem    â”‚
â”‚                                                 â”‚
â”‚ Performance:           3x faster than JSON      â”‚
â”‚ Zero allocation:       Using ArrayPool & Span  â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Last Updated:** January 2025  
**Phase:** 3.3 Serialization & Storage  
**Status:** Complete visual reference
